<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/my/layout/myLayout.html}">

            <div class="home" layout:fragment="content">

                <script>
                    // 클릭 이벤트 처리 함수
                    function preventClick(event, element) {
                        event.preventDefault(); // 기본 동작 중지
                        console.log(event);
                        console.log(element.getAttribute('data-bannerNo'));//이렇게 함수에 bannerNo를 담아서 옴
                        console.log(element.getAttribute('data-link'));//link주소도 받아와짐

                        const bannerNo = element.getAttribute('data-bannerNo');
                        const link = element.getAttribute('data-link');


                        const jsonData = {
                            "bannerNo":bannerNo,
                            "link":link
                        }

                        fetch("/lotteshop/main/index",{
                            method:'POST',
                            headers:{'Content-Type': 'application/json'},
                            body:JSON.stringify(jsonData)
                        })
                            .then(response=>{
                                if(!response.ok){
                                    throw new Error('데이터 전송에 실패!');
                                }else{
                                    window.location.href=link;
                                }
                                return response.json();
                            })
                            .then(data =>{
                                console.log(data);
                            })
                            .catch(err=>console.log(err))
                    }

                    /*리뷰 창 띄우기 시작*/
                    document.querySelectorAll('.review').forEach(function (link) {
                        link.addEventListener('click', function (event) {
                            const prodno = link.getAttribute("data-prodno");
                            const uid = link.getAttribute("data-uid");
                            const prodname = link.getAttribute("data-prodname");

                            console.log(prodno); // prodno 값 확인
                            console.log(uid);
                            console.log(prodname);

                            event.preventDefault();
                            openModal(uid,prodno,prodname);

                        });

                    });

                    // 사용자가 모달 바깥을 클릭하면 모달이 닫히도록 설정
                    window.onclick = function(event) {
                        var modal = document.getElementById('reviewModal');
                        var close = document.getElementById('close_btn');

                        if (event.target === modal || event.target===close) {
                            closeModal();
                        }
                    }


                    //모달 띄우기
                    async function openModal(uid,prodno,prodname) {
                        document.getElementById('reviewModal').style.display = 'block';
                        setModalContent(uid,prodno,prodname);
                    }

                    // 모달 닫기
                    function closeModal() {
                        document.getElementById('reviewModal').style.display = 'none';
                    }

                    // 모달 창이 열릴 때 사용자에게 보여줄 정보 설정
                    function setModalContent(uid,prodno,prodname) {
                        document.getElementById('uid').value = uid;
                        document.getElementById('prodno').value = prodno;
                        document.getElementById('prodname').value = prodname;

                    }

                    //리뷰에 별 색상 스타일
                    const stars = document.querySelectorAll('.star');
                    const ratingInput = document.getElementById('rating');

                    stars.forEach(function(star) {
                        star.addEventListener('click', function() {
                            const ratingValue = parseInt(star.getAttribute('data-rating'));
                            ratingInput.value = ratingValue;
                            stars.forEach(function(s, index) {
                                if (index < ratingValue) {
                                    s.classList.add('active');
                                } else {
                                    s.classList.remove('active');
                                }
                            });
                        });
                    });

                </script>

                <style>

                    /* 모달 시작! */
                    .modal {
                        display: none;
                        position: fixed;
                        z-index: 1000;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        overflow: auto;
                        background-color: rgba(0, 0, 0, 0.5);
                    }

                    .modal-content {
                        background-color: #fff;
                        margin: 15% auto;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
                        width: 80%;
                        max-width: 600px;
                        position: relative;
                    }

                    h3 {
                        font-size: 24px;
                        font-weight: bold;
                        color: #333;
                        margin-bottom: 20px;
                        text-align: center;
                    }

                    form {
                        margin-top: 20px;
                    }

                    .form-group {
                        margin-bottom: 20px;
                    }

                    label {
                        font-size: 18px;
                        color: #333;
                        font-weight: bold;
                        margin-bottom: 5px;
                        display: block;
                    }

                    input[type="text"],
                    input[type="number"],
                    textarea {
                        width: 100%;
                        padding: 10px;
                        font-size: 16px;
                        border-radius: 5px;
                        border: 1px solid #ccc;
                    }

                    textarea {
                        resize: vertical;
                    }

                    button[type="submit"] {
                        background-color: #007bff;
                        color: #fff;
                        border: none;
                        padding: 10px 20px;
                        font-size: 18px;
                        border-radius: 5px;
                        cursor: pointer;
                    }

                    button[type="submit"]:hover {
                        background-color: #0056b3;
                    }

                    .close_btn {
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        font-size: 24px;
                        color: #aaa;
                        cursor: pointer;
                        transition: color 0.3s;
                    }

                    .close_btn:hover {
                        color: #555;
                    }


                    .rating {
                        display: inline-block;
                        unicode-bidi: bidi-override;
                        direction: ltr;/*좌->우로 별 채우기 (반대는 rtl)*/
                    }

                    .star {
                        font-size: 25px;
                        cursor: pointer;
                        color: #ccc;
                    }

                    .star.active {
                        color: gold;
                    }
                    /*모달 끝!*/
                </style>

				<ul>
                    <span class="menu_else"></span>
                    <li><a th:href="@{/my/order}">전체주문내역</a></li>
                    <li><a th:href="@{/my/favorite}">관심상품</a></li>
                    <li><a th:href="@{/my/point}">포인트내역</a></li>
                    <li><a th:href="@{/my/coupon}">쿠폰</a></li>
                    <li ><a th:href="@{/my/review(uid=${#authentication.principal.username})}">나의리뷰</a></li>
                    <li><a th:href="@{/my/qna}">문의하기</a></li>
                    <li><a th:href="@{/my/info}">나의설정</a></li>
                </ul>

                <section>
                    <th:block th:each="banner :${banner5}">
                        <a th:if="${banner.status} == 1" th:data-bannerNo="${banner.bannerNo}" th:data-link="${banner.link}" th:onclick="'preventClick(event ,this)'" th:href="@{${banner.link}}">
                            <img th:src="@{/uploads/__${banner.img_810}__}" alt="패션, 타운 하나로 끝" class="banner">
                        </a>
                    </th:block>
                    <article class="latest">
                        <h3>최근주문내역</h3>
                        <a th:href="@{/my/order}" class="more">더보기</a>
                        <table border="0">
                            <tr>
                                <th>날짜</th>
                                <th>상품정보</th>
                                <th>상태</th>
                                <th>확인/신청</th>
                            </tr>
                            <tr>
                                <td class="date">2022-12-13</td>
                                <td class="info">
                                    <a th:href="@{#}" class="thumb"><img src="https://via.placeholder.com/80x80" alt=""></a>
                                    <ul>
                                        <li class="company"><a th:href="@{#}">상호명</a></li>
                                        <li class="prodName"><a th:href="@{#}">상품명</a></li>
                                        <li class="orderNo">수량 : <span class="prodCount">1</span>개 / 주문번호 : <a th:href="@{#}">1012211341</a></li>
                                        <li class="prodPrice">34,000</li>
                                    </ul>
                                </td>
                                <td class="status">배송완료</td>
                                <td class="confirm">
                                    <a th:href="@{#}" class="receive">수취확인</a>
                                    <a th:href="@{#}" class="review">상품평</a>
                                    <a th:href="@{#}" class="refund">반품신청</a>
                                    <a th:href="@{#}" class="exchange">교환신청</a>
                                </td>
                            </tr>
                        </table>
                    </article>

                    <article class="point">
                        <h3>포인트내역</h3>
                        <a th:href="@{/my/point}" class="more">더보기</a>
                        <table border="0">
                            <tr>
                            <tr>
                                <th>날짜</th>
                                <th>구분</th>
                                <th>주문번호</th>
                                <th>적립(차감)내역</th>
                                <th>비고</th>
                                <th>유효기간</th>
                            </tr>
                            <th:block th:each="point , index:${points}"  th:if="${index.index <3}">
                            <tr style="text-align: center">
                                <td >[[${#temporals.format(point.pointDate , 'yyyy-MM-dd')}]]</td>
                                <td>[[${point.state}]]</td>
                                <td>[[${point.orderNo}]]</td>
                                <td>[[${point.point}]]</td>
                                <td>[[${point.pointDesc}]]</td>
                                <td >[[${point.endDateTime}]]</td>
                            </tr>
                            </th:block>
                        </table>

                    </article>
                    <article class="review">
                        <h3>상품평</h3>
                        <a th:href="@{/my/review(uid=${#authentication.principal.username})}" class="more">더보기</a>
                        <table border="0">
                            <tr>
                                <th>번호</th>
                                <th>상품명</th>
                                <th>내용</th>
                                <th>평점</th>
                                <th>작성일</th>
                            </tr>
                            <tr th:each="review, iterStat : ${reviews}">
                                <td th:text="${iterStat.count}">1</td><!--인덱스 가져와서 인덱스 번호찍기-->
                                <td th:text="${review.getProdname()}">상품명</td>
                                <td class="content"
                                    th:text="${#strings.length(review.getComment()) > 10 ? #strings.substring(review.getComment(), 0, 10) + '...' : review.getComment()} ">
                                    배송이 빠릅니다. 잘 사용하겠습니다.
                                </td>
                                <td class="score">
                                    <h5>
                                        <img th:if="${review.getScore()} == 1 " th:src="@{/review/review_star1.png}"
                                             alt="oneStar"
                                             style="max-width: 80px; height: auto;">
                                        <img th:if="${review.getScore()} == 2 " th:src="@{/review/review_star2.png}"
                                             alt="oneStar"
                                             style="max-width: 80px; height: auto;">
                                        <img th:if="${review.getScore()} == 3 " th:src="@{/review/review_star3.png}"
                                             alt="oneStar"
                                             style="max-width: 80px; height: auto;">
                                        <img th:if="${review.getScore()} == 4 " th:src="@{/review/review_star4.png}"
                                             alt="oneStar"
                                             style="max-width: 80px; height: auto;">
                                        <img th:if="${review.getScore()} == 5 " th:src="@{/review/review_star5.png}"
                                             alt="oneStar"
                                             style="max-width: 80px; height: auto;"></h5>
                                </td>
                                <td class="date" th:text="${#temporals.format(review.getRdate(),'yyyy-MM-dd')}">2024-12-12</td>
                            </tr>
                        </table>
                    </article>

                    <article class="qna">
                        <h3>문의내역</h3>
                        <a th:href="@{#}" class="more">더보기</a>
                        <table border="0">
                            <tr>
                                <th>번호</th>
                                <th>문의채널</th>
                                <th>문의유형</th>                                
                                <th>제목</th>
                                <th>작성일</th>
                                <th>상태</th>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>고객센터</td>
                                <td>주문/결제</td>                                
                                <td>신용카드 결제 중 오류가 난 경우 어떻게 하나요?</td>
                                <td>2024-12-12</td>
                                <td><span class="notAnswerYet">검토중</span></td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>고객센터</td>
                                <td>주문/결제</td>                                
                                <td>신용카드 결제 중 오류가 난 경우 어떻게 하나요?</td>
                                <td>2024-12-12</td>
                                <td><span class="answered">답변완료</span></td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>판매자게시판</td>
                                <td>배송</td>                                
                                <td>배송기간이 보통 얼마나 걸리나요?</td>
                                <td>2024-12-12</td>
                                <td><span class="answered">답변완료</span></td>
                            </tr>
                        </table>
                    </article>

                    <article class="myinfo">
                        <h3>확인해주세요!</h3>

                        <div>
                            <div class="address">
                                <span>기본 배송지설정</span>
                                <a th:href="@{#}" class="setting">변경</a>
                            </div>
                            <div class="email">
                                <span>email 설정</span>
                                <a th:href="@{#}" class="setting">변경</a>
                                <p>
                                    <span>abc123@gmail.com</span><br/>
                                    (최종수정일 <span>2021-12-10</span>)
                                </p>
                            </div>
                            <div class="hp">
                                <span>휴대폰 설정</span>
                                <a th:href="@{#}" class="setting">변경</a>
                                <p>
                                    <span>abc123@gmail.com</span><br/>
                                    (최종수정일 <span>2021-12-10</span>)
                                </p>
                            </div>
                        </div>
                    </article>

                    <!-- 리뷰 작성을 위한 모달 -->
                    <div id="reviewModal" class="modal">
                        <div class="modal-content">
                            <span id="close_btn" class="close_btn">&times;</span>
                            <h3>리뷰 작성</h3>
                            <form th:action="@{/my/order/write_review}" id="reviewForm" method="post" enctype="multipart/form-data">
                                <input type="hidden" id="prodno" name="prodno"/>
                                <input type="hidden" id="prodname" name="prodname"/>
                                <input type="hidden" id="uid" name="uid"/>
                                <div class="form-group">
                                    <label for="reviewTitle">제목:</label>
                                    <input type="text" id="reviewTitle" name="title" required>
                                </div>
                                <div class="form-group">
                                    <label for="reviewContent">내용:</label>
                                    <textarea id="reviewContent" name="comment" rows="5" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="reviewRating">평점:</label>
                                    <div class="rating" id="reviewRating">
                                        <span class="star" data-rating="1">&#9733;</span>
                                        <span class="star" data-rating="2">&#9733;</span>
                                        <span class="star" data-rating="3">&#9733;</span>
                                        <span class="star" data-rating="4">&#9733;</span>
                                        <span class="star" data-rating="5">&#9733;</span>
                                    </div>
                                    <input type="hidden" name="score" id="rating">
                                </div>
                                <div class="form-group">
                                    <label for="reviewImage">이미지 업로드:</label>
                                    <input type="file" id="reviewImage" name="multImage1">
                                </div>
                                <button class="btn_review" type="submit">리뷰 작성</button>
                            </form>
                        </div>
                    </div>
                    <!-- 리뷰 작성 모달 끝 -->


                </section>

            </div>


    </div>    
</body>
</html>