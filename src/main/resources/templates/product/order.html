<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/productLayout}">

<div class="container" layout:fragment="content">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>

        window.onload = function (){
            orderPriceSub(0);
            //자 주문해보자.. 뭐 해야하냐.. 아.. 귀찮다..
            //1. orderTable에 넣어야하고 (상태는 주문 접수 대기)
            //2. 사용한 포인트가 0 이상이면 제거해야하고
            //3. 카트 이용했으면 장바구니에서 삭제해야 하고
            //4. 상품 재고도 빼야함

            //4. 추후 주문 확정시 포인트 적립
            document.getElementById('buyButton').onclick=function (){
                forOrder();
            }
        }

        //우편번호 검색
        function postcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                    // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                    // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                    var addr = ''; // 주소 변수
                    var extraAddr = ''; // 참고항목 변수

                    //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                    if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                        addr = data.roadAddress;
                    } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        addr = data.jibunAddress;
                    }

                    // 우편번호와 주소 정보를 해당 필드에 넣는다.
                    document.getElementById('inputZip').value = data.zonecode;
                    document.getElementById("inputAddr1").value = addr;
                    // 커서를 상세주소 필드로 이동한다.
                    document.getElementById("inputAddr2").focus();
                }
            }).open();
        }

        //포인트 사용
        let isPointOk = false;
        function usingPoint(){
            //alert('클릭이 되었습니다.');
            //포인트를 사용한다고 적용 버튼을 눌렀을 때, 5000점 이상이면 현금처럼 사용가능
            const curPoint = document.getElementsByClassName('curPoint')[0].textContent;
            const usingPoint = document.getElementById('point').value;
            const totalOrder = document.getElementById('totalOrder').textContent;
            const order = totalOrder.replace(/,/g, '');
            const result = document.getElementById('result');//적용했을때의 결과를 띄워줌

            if(parseInt(curPoint)>0 && parseInt(usingPoint) >0){
                //1.나의 포인트 보다 사용포인트를 많이 입력했을 경우
                console.log(curPoint);
                console.log(usingPoint);
                console.log(curPoint <usingPoint);
                if(parseInt(curPoint)<parseInt(usingPoint)){
                    //result쪽에 사용이 불가능하다고 띄워줌
                    result.innerText="포인트가 부족합니다!";
                    result.style.color="red";
                } else if(usingPoint>parseInt(order)){
                    result.innerText="결제금액보다 사용포인트가 많습니다!";
                    result.style.color="red";
                }else{
                    result.innerText="사용 가능합니다!";
                    result.style.color="green";
                    orderPriceSub(usingPoint);
                }

            }else{
                alert('포인트는 1 이상부터 사용가능힙니다.');
                isPointOk = false;
            }
        }
        async function forOrder() {
            var isOk = true;
            const reHp = /^01(?:0|1|[6-9])-(?:\d{4})-\d{4}$/;
            //뭐가필요하냐...
            //주문자 + 휴대폰 + 우편번호 + 기본주소 + 상세주소
            const userId = document.getElementById('userId').value;
            const sendName = document.getElementById('sendName').value;
            const sendHp = document.getElementById('sendHp').value;
            const zip = document.getElementById('inputZip').value;
            const addr1 = document.getElementById('inputAddr1').value;
            const addr2 = document.getElementById('inputAddr2').value;
            const payments = document.getElementsByName('payment');
            let point = document.getElementById('inputUsingPoint').innerText;
            console.log(point)
            point = parseFloat(point.replace(/[^\d.-]/g, ''));
            let itemDiscount = document.getElementById('totalDiscount').innerText;
            itemDiscount = parseFloat(itemDiscount.replace(/[^\d.-]/g, ''));
            let orderTotalPrice = document.getElementById('totalOrder').innerText;
            orderTotalPrice = parseFloat(orderTotalPrice.replace(/[^\d.-]/g, ''));

            var payment = '';
            payments.forEach(function (item) {
                if (item.checked) {
                    payment = item.value;
                }
            })
            if (zip === '') {
                isOk = false;
                alert('배송 주소를 입력해주세요.')
                return;
            }
            if (sendName === '') {
                isOk = false;
                alert('이름을 정확히 입력해주세요.')
                return;
            }
            if (!sendHp.match(reHp)) {
                isOk = false;
                alert('휴대폰 번호를 ' - '을 포함하여 정확히 입력해주세요.')
                return;
            }
            if (payment === '') {
                isOk = false;
                alert('결제 방식을 선택해주세요.');
                return;
            }
            console.log(point);
            const jsonData = {
                userId: userId, sendName: sendName, sendHp: sendHp,
                zip: zip, addr1: addr1, addr2: addr2, payment: payment, point: point, orderTotalPrice: orderTotalPrice
                , itemDiscount: itemDiscount
            };
            console.log(jsonData)
            const result = await fetchPost('/lotteshop/product/orderBuy', jsonData);
            console.log(result.orderNo)
            if (result.orderNo != null){
                order2(result.orderNo);
            }
        } // orderfunction 끝

        async function order2(orderNo) {
            //이제 카트 제거하고, orderItems 넘겨줄 것임
            const status = parseInt([[${status}]]);
            if (status == 1) {
                const cartNo = document.getElementsByName('cartNo');
                let lists = [];
                lists.push(orderNo);
                cartNo.forEach(function (item) {
                    lists.push(item.value);
                })
                const json = {lists: lists}
                const result = await fetchPost('/lotteshop/product/deleteCartForOrder', json);
                if(result.data != null){
                    alert('주문이 완료되었습니다.')
                    window.location.href='/lotteshop/'
                }
            } else {
                const result = await fetchGet('/lotteshop/product/insertItems?orderNo=' + orderNo);
                if(result.data != null){
                    alert('주문이 완료되었습니다.')
                    window.location.href='/lotteshop/'
                }
            }

        }
        //// 각 장바구니 품목 가격 합산하는 함수 ////
        function orderPriceSub(usingPoint) {
            let totalProdPrice = 0;
            let totalProdDisPrice = 0;
            let totalProdDelCost = 0;
            let totalProdPoint = 0;
            let totalProdTotal = 0; //최종가격
            const subProductTotalPrice =document.querySelectorAll('#subProductTotalPrice');
            const subProductOriginPrice =document.querySelectorAll('#subProductOriginPrice');
            const subProductDelivery =document.querySelectorAll('#subProductDelivery');
            const productsPoint =document.querySelectorAll('#productsPoint');

            subProductDelivery.forEach(function (item){
                totalProdDelCost+= parseInt(item.innerText);
            });

            subProductOriginPrice.forEach(function (item){
                totalProdPrice+= parseInt(item.innerText);
            });

            subProductTotalPrice.forEach(function (item){
                totalProdTotal+= parseInt(item.innerText);
            });

            totalProdDisPrice = totalProdPrice - totalProdTotal;

            productsPoint.forEach(function (item){
                totalProdPoint+= parseInt(item.innerText);
            });

            const totalPrice = document.getElementById('totalPrice');
            const totalDiscount = document.getElementById('totalDiscount');
            const totalDelCost = document.getElementById('totalDelCost');
            const totalPoint = document.getElementById('totalPoint');
            const totalOrder = document.getElementById('totalOrder');
            const inputUsingPoint = document.getElementById('inputUsingPoint');

            if(usingPoint>0){
                inputUsingPoint.innerText =usingPoint +'원';
                if(totalProdTotal<30000){
                    totalDelCost.innerText=totalProdDelCost +'원';
                    totalOrder.innerText =( parseInt(totalProdTotal) + parseInt(totalProdDelCost) -parseInt(usingPoint)) +'원';
                }else{
                    totalDelCost.innerText= '무료배송';
                    totalOrder.innerText =( parseInt(totalProdTotal) -parseInt(usingPoint)) +'원';
                }

            }else{
                inputUsingPoint.innerText ='사용 포인트 없음';
                if(totalProdTotal<30000){
                    totalDelCost.innerText=totalProdDelCost +'원';
                    totalOrder.innerText =( parseInt(totalProdTotal) + parseInt(totalProdDelCost)) +'원';
                }else{
                    totalDelCost.innerText= '무료배송';
                    totalOrder.innerText =( parseInt(totalProdTotal)) +'원';
                }
            }


                totalPrice.innerText=totalProdPrice +'원';
            totalDiscount.innerText=totalProdDisPrice +'원';

            totalPoint.innerText=totalProdPoint +'원';

                }
    </script>

    <main id="product">
        <aside>
            <ul class="category">
                <li><i class="fa fa-bars" aria-hidden="true"></i>카테고리</li>
                <li>
                    <a href="#"><i class="fas fa-tshirt"></i>패션·의류·뷰티</a>
                    <ol>
                        <li><a href="#">남성의류</a></li>
                        <li><a href="#">여성의류</a></li>
                        <li><a href="#">잡화</a></li>
                        <li><a href="#">뷰티</a></li>
                    </ol>
                </li>
                <li>
                    <a href="#"><i class="fas fa-laptop"></i>가전·디지털</a>
                    <ol>
                        <li><a href="#">노트북/PC</a></li>
                        <li><a href="#">가전</a></li>
                        <li><a href="#">휴대폰</a></li>
                        <li><a href="#">기타</a></li>
                    </ol>
                </li>
                <li>
                    <a href="#"><i class="fas fa-utensils"></i>식품·생필품</a>
                    <ol>
                        <li><a href="#">신선식품</a></li>
                        <li><a href="#">가공식품</a></li>
                        <li><a href="#">건강식품</a></li>
                        <li><a href="#">생필품</a></li>
                    </ol>
                </li>
                <li>
                    <a href="#"><i class="fas fa-home"></i>홈·문구·취미</a>
                    <ol>
                        <li><a href="#">가구/DIY</a></li>
                        <li><a href="#">침구·커튼</a></li>
                        <li><a href="#">생활용품</a></li>
                        <li><a href="#">사무용품</a></li>
                    </ol>
                </li>
            </ul>
        </aside>

        <!-- 주문 페이지 시작-->
        <section class="order">

            <!-- 제목, 페이지 네비게이션 -->
            <nav>
                <h1>주문결제</h1>
                <p>
                    HOME > 장바구니 > <strong>주문결제</strong>
                </p>
            </nav>
            <th:block th:if="${status == 1}">
                <th:block th:each="cart , index:${cartlist}">
                <input type="hidden" name="cartNo" th:value="${cart.getCartNo()}">
                </th:block>
            </th:block>
            <form action="#">
                <!-- 주문 상품 목록 -->
                <table>
                    <thead>
                    <tr>
                        <th>상품명</th>
                        <th>총수량</th>
                        <th>판매가</th>
                        <th>할인(%)</th>
                        <th>배송비</th>
                        <th>소계(배송비 제외)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr  class="empty">
                        <td colspan="7">주문하실 상품이 없습니다.</td>
                    </tr>
                    <tr th:each="subProduct , index:${subProducts}">
                        <td>
                            <article class="orderProd">
                                <a href="#"><img th:src="@{/uploads/__${subProduct.products.image1}__}" alt=""></a>
                                <div>
                                    <h2 th:text="${subProduct.products.prodName}"><a href="#">상품명</a></h2>
                                    <p th:text="${subProduct.size + '  ' + subProduct.color}">상품설명</p>
                                </div>
                            </article>
                        </td>
                        <td th:text="${counts[index.index]}"></td>
                        <td th:text="${subProduct.prodPrice }"></td>
                        <td th:text="${subProduct.products.getProdDiscount() +'%'}"></td>
                        <td class="delivery" id="subProductDelivery">[[${subProduct.products.delivery}]]</td>
                        <td id="subProductTotalPrice" th:text="${#numbers.formatDecimal(subProduct.prodPrice * (100 - subProduct.products.prodDiscount) * 0.01 * counts[index.index] ,1,0) }"></td>
                        <td id="subProductOriginPrice" style="display: none" th:text="${#numbers.formatDecimal(subProduct.prodPrice * counts[index.index] ,1,0) }"></td>
                        <td id="productsPoint" style="display: none" th:text="${subProduct.products.point * counts[index.index]}"></td>
                    </tr>
                    </tbody>
                </table>
                ** 포인트는 주문 확인 후 적립됩니다. **
                <!-- 최종 결제 정보-->
                <div class="final">
                    <h2>최종결제 정보</h2>
                    <table border="0">
                        <tr>
                            <td>주문 건수</td>
                           <td id="totalCount" th:text="${counts.size()}+'건'"></td>
                        </tr>
                        <tr>
                            <td>총 상품금액</td>
                            <td id = totalPrice></td>
                        </tr>
                        <tr>
                            <td>할인금액</td>
                            <td id="totalDiscount"></td>
                        </tr>
                        <tr>
                            <td>배송비</td>
                            <td id="totalDelCost"></td>
                        </tr>
                        <tr>
                            <td>포인트 할인</td>
                            <td id="inputUsingPoint"></td>
                        </tr>
                        <tr>
                            <td>포인트 적립</td>
                            <td id="totalPoint"></td>
                        </tr>
                        <tr>
                            <td>결제금액</td>
                            <td id="totalOrder"></td>
                        </tr>
                    </table>
                    <input type="button" name="" id="buyButton" value="결제하기">
                </div>

                <!-- 배송정보 -->
                <input type="hidden" id="userId" th:value="${user.uid}"/>
                <article class="delivery">
                    <h1>배송정보</h1>
                    <table>
                        <tr>
                            <td>주문자</td>
                            <td><input type="text" name="sendName" id="sendName" th:value="${user.name}"/></td>

                        </tr>
                        <tr>
                            <td>휴대폰</td>
                            <td>
                                <input type="text" name="sendHp" id="sendHp" th:value="${user.hp}"/>
                                <span>- 포함 입력</span>
                            </td>
                        </tr>
                        <tr>
                            <td>우편번호</td>
                            <td>
                                <input type="text" id="inputZip" name="zip" readonly/>
                                <input type="button" id="findZip" value="검색" onclick="postcode()"/>
                            </td>
                        </tr>
                        <tr>
                            <td>기본주소</td>
                            <td>
                                <input type="text" id="inputAddr1" name="addr1"/>
                            </td>
                        </tr>
                        <tr>
                            <td>상세주소</td>
                            <td>
                                <input type="text" id="inputAddr2" name="addr2"/>
                            </td>
                        </tr>
                    </table>
                </article>

                <article class="discount">
                    <h1>할인정보</h1>

                    <div>
                        <p>현재 포인트 : <span class="curPoint" th:text="${user.totalPoint}" ></span>점</p>
                        <label>
                            <input type="text" id="point" name="point"/>점
                            <input type="button" onclick="usingPoint()" value="적용"/><br>
                            <span id="result"></span>
                        </label>
                    </div>
                </article>

                <!-- 결제방법 -->
                <article class="payment" id="payment">
                    <h1>결제방법</h1>
                    <div>
                        <span>신용카드</span>
                        <p>
                            <label><input type="radio" name="payment" value="신용카드"/>신용카드 결제</label>
                            <label><input type="radio" name="payment" value="체크카드"/>체크카드 결제</label>
                        </p>
                    </div>
                    <div>
                        <span>계좌이체</span>
                        <p>
                            <label><input type="radio" name="payment" value="실시간 계좌이체"/>실시간 계좌이체</label>
                            <label><input type="radio" name="payment" value="무통장 입금"/>무통장 입금</label>
                        </p>
                    </div>
                    <div>
                        <span>기타</span>
                        <p>
                            <label><input type="radio" name="payment" value="휴대폰결제"/>휴대폰결제</label>
                            <label>
                                <input type="radio" name="payment" value="카카오페이"/>카카오페이
                                <img src="../images/ico_kakaopay.gif" alt="카카오페이"/>
                            </label>
                        </p>
                    </div>
                </article>

                <!-- 경고 -->
                <article class="alert">
                    <ul>
                        <li><span>롯데ON의 모든 판매자는 안전거래를 위해 구매금액, 결제수단에 상관없이 모든거래에 대하여 롯데ON 유한책임회사의 구매안전서비스(에스크로)를 제공하고 있습니다.</span>
                        </li>
                        <li><span>롯데ON 유한책임회사의 전자금융거래법에 의해 결제대금예치업 등록번호는 02-006-00008 입니다.</span></li>
                        <li><span>등록여부는 금융감독원 홈페이지(www.fss.or.kr)의 업무자료>인허가업무안내>전자금융업등록현황에서 확인하실수 있습니다.</span></li>
                    </ul>
                </article>

            </form>

        </section>
        <!-- 주문 페이지 끝-->
    </main>
</div>
</html>